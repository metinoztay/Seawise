
@{
    ViewData["Title"] = "OwnerProfile";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    string ownerPhotoUrl = Model.PhotoUrl;
}
@model ShipOwner

<div class="card card-success card-outline">
    <div class="card-header">

        <h3 class="card-title"><i class="fas fa-id-card-alt"></i> &nbsp; Ship Owner's Profile</h3>

        <div class="card-tools">
            <button type="button" class="btn btn-tool" id="saveButton" hidden="hidden" >
                <i class="fas fa-save"></i>
            </button>
            <button type="button" class="btn btn-tool" id="editButton">
                <i class="fas fa-edit"></i>
            </button>
            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus"></i>
            </button>
            <button type="button" class="btn btn-tool" data-card-widget="remove">
                <i class="fas fa-times"></i>
            </button>
        </div>

    </div>
    <!-- /.card-header -->
    <div class="card-body">
        <div class="row">            
            <div class="col-2 text-center">
                <img src="@Model.PhotoUrl" alt="user-avatar" id="ownerPhoto" class="img-circle img-fluid">
                <div style="height:25px;"> </div>

                <!-- Fotoğraf yükleme için gizli input -->
                <input type="file" id="fileInput" style="display: none;" accept="image/*" />

                <!-- Buton -->
                <button type="button" class="btn btn-outline-success btn-block" id="uploadButton" hidden>
                    <i class="fas fa-upload"></i>  Upload New Photo
                </button>
            </div>


            <div class="col-md-5">
                <div class="form-group">
                    <label>Name</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="far fa-id-card"></i></span>
                        </div>
                        <input type="text" class="form-control" value="@Model.Name" id="ownerName" readonly="readonly">
                    </div>
                </div>
                <!-- /.form-group -->
                <div class="form-group">
                    <div class="form-group">
                        <label>Phone</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                            </div>
                            <input type="text" class="form-control" id="ownerPhone" value="@Model.Phone" readonly="">
                        </div>
                    </div>

                <div class="form-group">
                    <label>Address </label><div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-map-marked-alt"></i></span>
                        </div>
                        <textarea class="form-control" rows="3" readonly="" id="ownerAddress" style="height: 107px;">@Model.Address</textarea>
                    </div>

                </div>

                
                    <!-- /.form-group -->
                </div>
                <!-- /.form-group -->
            </div><div class="col-md-5">
                <div class="form-group">
                    <label>About</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-info-circle"></i></span>
                        </div>
                        <input type="text" class="form-control" value="@if (Model.IsPerson)
                               {
                        <text>This owner is an individual.</text>
                        }
                        else
                        {
                        <text>This owner is a company.</text>
                        }" id="ownerAbout" readonly="readonly">
                    </div>
                </div>
                <!-- /.form-group -->
                

                <div class="form-group">
                    <div class="form-group">
                        <label>E-Mail</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                            </div>
                            <input type="text" class="form-control" id="ownerEmail" value="@Model.Email" readonly="">
                        </div>
                    </div>
                    <!-- /.form-group -->
                </div>

                <div class="form-group">
                    <label>Country</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-flag"></i></span>
                        </div>
                        <select class="form-control select2bs4 select2-hidden-accessible" style="width: 80%;" id="ownerCountry" disabled>
                            @using Seawise.Data
                            @foreach (var country in Countries.countries)
                            {
                                if (country.CountryCode == Model.CountryCode)
                                {
                                    <option selected="selected" value="@country.CountryCode" data-image="/images/flags/@(country.CountryCode).svg">@country.CountryName</option>
                                }
                                else
                                {
                                    <option value="@country.CountryCode" data-image="/images/flags/@(country.CountryCode).svg">@country.CountryName</option>
                                }
                            }
                        </select>



                    </div>
                 </div>


               
                <!-- /.form-group -->
            </div>
            <!-- /.col -->
            <!-- /.col -->
        </div>
        <!-- /.row -->


    </div>
    <!-- /.card-body -->
    <div class="card-footer"></div>
</div>

<div style="height:15px"></div>

<div class="card card-primary card-outline">
    <div class="card-header">

        <h3 class="card-title"><i class="fas fa-ship"></i> &nbsp; Ship List</h3>

        <div class="card-tools">
            
            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus"></i>
            </button>
            <button type="button" class="btn btn-tool" data-card-widget="remove">
                <i class="fas fa-times"></i>
            </button>
        </div>

    </div>
    <!-- /.card-header -->
    <div class="card-body">
        <div class="row">
            
            @foreach(var ship in Model.Ships)
            {
                <div class="col-md-3">
                    <button class="card card-outline card-primary btn-block shadow" style=" padding:0; text-align:left; background-color:transparent; " onclick="redirectToShipDetails(@ship.ShipId)">
                        <img cap" alt="" style="height: 180px; width: 100%; display: block;" src="@ship.PhotoUrl" data-holder-rendered="true">
                        <div class="card-body">
                            <dl>
                                <dt>@ship.ShipName &nbsp; <img src="~/images/flags/@($"{ship.CountryCode}.svg")" style="height: 15px;" class="elevation-2" alt="User Image"> </dt>
                                <dd>Owner: @ship.ShipOwner.Name</dd>
                            </dl>
                        </div>
                    </button>
                </div>
            }

        </div>
        <!-- /.row -->
    </div>
    <!-- /.card-body -->
    <div class="card-footer"></div>
</div>



@section Scripts {
        
    <script>
        $(document).ready(function () {
            // Edit butonuna tıklandığında
            $('#editButton').click(function () {

                $('#ownerName,#ownerPhone,#ownerAddress,#ownerEmail').removeAttr('readonly');
                $('#ownerCountry').removeAttr('disabled');
                ownerCountry
                // Save butonunu göster
                $('#saveButton,#uploadButton').removeAttr('hidden');
                $('#editButton').attr('hidden', true);

            });

            // Save butonuna tıklandığında
            $('#saveButton').click(function () {
                $('#ownerName,#ownerPhone,#ownerAddress,#ownerEmail').attr('readonly', true);
                // Burada kaydetme işlemlerini gerçekleştirebilirsiniz

                var ownerData = {
                    ShipOwnerId: parseInt('@Model.ShipOwnerId'), // JavaScript'te sayı olarak kullanılması için
                    Name: $('#ownerName').val(),
                    Email: $('#ownerEmail').val(),
                    Phone: $('#ownerPhone').val(),
                    Address: $('#ownerAddress').val(),
                    CountryCode: $('#ownerCountry').val(),
                    PhotoUrl: document.getElementById('ownerPhoto').src
                };


                // AJAX ile gönder
                $.ajax({
                    url: '@Url.Action("UpdateShipOwner", "Owner")', // Doğru URL'yi kullanıyoruz
                    type: 'POST',
                    contentType: 'application/x-www-form-urlencoded',
                    data: (ownerData),
                    success: function (response) {
                        alert("Data saved!");
                        // Burada kaydetme işlemlerini gerçekleştirebilirsiniz
                    },
                    error: function (error) {
                        alert('Error saving data!');
                    }
                });


                // Save butonunu gizle
                $('#ownerCountry').attr('disabled', true);
                $('#saveButton,#uploadButton').attr('hidden', true);
                $('#editButton').removeAttr('hidden');// Save butonunu gizle
            });
        });

        
    </script>

    <script>
        $(function () {
            //Initialize Select2 Elements
            $('.select2').select2();

            //Initialize Select2 Elements with Bootstrap 4 theme
            $('.select2bs4').select2({
                theme: 'bootstrap4'
            });
        });

        $(document).ready(function () {
            $('#ownerCountry').select2({
                theme: 'bootstrap4',
                templateResult: formatCountry,
                templateSelection: formatCountry
            });

            function formatCountry(country) {
                if (!country.id) {
                    return country.text; // Return unformatted if there's no id (for placeholder)
                }

                var countryFlag = $(country.element).data('image');
                if (countryFlag) {
                    var $country = $(
                        '<span><img src="' + countryFlag + '" style="height: 15px; margin-right: 8px;" /> ' + country.text + '</span>'
                    );
                    return $country;
                }

                return country.text;
            }
        });

    </script>

    <script>
        document.getElementById('uploadButton').addEventListener('click', function () {
            document.getElementById('fileInput').click();  // Dosya seçme ekranını aç
        });

        document.getElementById('fileInput').addEventListener('change', function () {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];  // Seçilen dosyayı al

            if (file) {
                // Dosya geçerliliğini kontrol et
                const validImageTypes = ['image/jpeg', 'image/jpg', 'image/png'];
                if (!validImageTypes.includes(file.type)) {
                    alert("Lütfen geçerli bir fotoğraf dosyası seçin (JPEG, JPG, PNG).");
                    return;
                }

                const photoData = new FormData();
                photoData.append('file', file);
                photoData.append('ownerId', @Model.ShipOwnerId);

                fetch('@Url.Action("UploadPhoto", "Owner")', {
                    method: 'POST',
                    body: photoData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.filePath) {
                            // Sunucudan dönen dosya yolunu önizlemede göster
                            document.getElementById('ownerPhoto').src = data.filePath;
                        } else {
                            alert(data.message || "Dosya yüklenirken bir hata oluştu.");
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            } else {
                alert("Lütfen bir dosya seçin.");
            }
        });
    </script>

}
